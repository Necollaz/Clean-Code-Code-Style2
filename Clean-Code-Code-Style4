namespace IMJunior
{
    public class Program
    {
        static void Main(string[] args)
        {
            List<IPaymentFactory> factories = new List<IPaymentFactory>
            {
                new QiwiFactory(),
                new WebMoneyFactory(),
                new CardFactory()
            };

            ApplicationContext applicationContext = new ApplicationContext(factories);
            OrderForm orderForm = new OrderForm(applicationContext);
            PaymentHandler paymentHandler = new PaymentHandler(applicationContext);
            var systemId = orderForm.ShowForm();
            IPaymentSystem paymentSystem = paymentHandler.Create(systemId);

            paymentSystem.Processing();
            paymentHandler.ShowResult(paymentSystem);
        }
    }

    public interface IPaymentSystem
    {
        public void Check();
        public void Processing();
    }

    public class QIWI : IPaymentSystem
    {
        public void Check()
        {
            Console.WriteLine("Перевод на страницу QIWI...");
        }

        public void Processing()
        {
            Console.WriteLine("Проверка платежа через QIWI...");
        }
    }

    public class WebMoney : IPaymentSystem
    {
        public void Check()
        {
            Console.WriteLine("Вызов API WebMoney...");
        }

        public void Processing()
        {
            Console.WriteLine("Проверка платежа через WebMoney...");
        }
    }

    public class Card : IPaymentSystem
    {
        public void Check()
        {
            Console.WriteLine("Вызов API банка эмитера карты Card...");
        }

        public void Processing()
        {
            Console.WriteLine("Проверка платежа через Card...");
        }
    }

    public interface IPaymentFactory
    {
        public string Name { get; }
        IPaymentSystem Create();
    }

    public class QiwiFactory : IPaymentFactory
    {
        public string Name => "QIWI";
        public IPaymentSystem Create() => new QIWI();
    }

    public class WebMoneyFactory : IPaymentFactory
    {
        public string Name => "WebMoney";
        public IPaymentSystem Create() => new WebMoney();
    }

    public class CardFactory : IPaymentFactory
    {
        public string Name => "Card";
        public IPaymentSystem Create() => new Card();
    }

    public class ApplicationContext
    {
        public IEnumerable<IPaymentFactory> Factories { get; }

        public ApplicationContext(IEnumerable<IPaymentFactory> factories)
        {
            Factories = factories ?? throw new ArgumentNullException(nameof(factories));
        }
    }

    public class OrderForm
    {
        private readonly ApplicationContext _context;

        public OrderForm(ApplicationContext context)
        {
            _context = context ?? throw new ArgumentNullException(nameof(context));
        }

        public string ShowForm()
        {
            string availableSystems = string.Join(", ", _context.Factories.Select(f => f.Name));

            Console.WriteLine("Мы принимаем: QIWI, WebMoney, Card");
            Console.WriteLine("Какое системой вы хотите совершить оплату?");

            return Console.ReadLine();
        }
    }

    public class PaymentHandler
    {
        private readonly ApplicationContext _context;

        public PaymentHandler(ApplicationContext context)
        {
            _context = context ?? throw new ArgumentNullException(nameof(context));
        }

        public IPaymentSystem Create(string systemId)
        {
            var factory = _context.Factories.FirstOrDefault(f => f.Name.Equals(systemId, StringComparison.OrdinalIgnoreCase));

            if (factory == null)
                throw new NotSupportedException($"Платёжная система {systemId} не поддерживается.");

            return factory.Create();
        }

        public void ShowResult(IPaymentSystem paymentSystem)
        {
            if (paymentSystem == null)
                throw new ArgumentNullException(nameof(paymentSystem));

            string systemId = paymentSystem.GetType().Name;

            Console.WriteLine($"Вы оплатили с помощью {systemId}");

            paymentSystem.Check();

            Console.WriteLine("Оплата прошла успешно!");
        }
    }
}
